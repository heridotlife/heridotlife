name: Auto PR from Develop to Main

# Trigger when changes are pushed to develop branch
# This includes when feature branches are merged to develop
#
# SETUP REQUIRED:
# Create a Personal Access Token (PAT) with 'repo' scope and save it as PAT_TOKEN secret
# GitHub Settings > Developer settings > Personal access tokens > Fine-grained tokens
# Required permissions: Contents (read/write), Pull requests (read/write)
on:
  push:
    branches:
      - develop

# Required permissions for creating/updating PRs
permissions:
  contents: write
  pull-requests: write

jobs:
  auto-pr:
    name: Create or Update PR to Main
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 # Fetch all history for proper diff

      - name: Check for existing PR
        id: check-pr
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # Check if there's already an open PR from develop to main
          PR_NUMBER=$(gh pr list \
            --base main \
            --head develop \
            --state open \
            --json number \
            --jq '.[0].number')

          if [ -n "$PR_NUMBER" ]; then
            echo "pr_exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            echo "Found existing PR #$PR_NUMBER"
          else
            echo "pr_exists=false" >> $GITHUB_OUTPUT
            echo "No existing PR found"
          fi

      - name: Update existing PR
        if: steps.check-pr.outputs.pr_exists == 'true'
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          PR_NUMBER: ${{ steps.check-pr.outputs.pr_number }}
        run: |
          # Add a comment to the existing PR
          gh pr comment $PR_NUMBER --body "ðŸ”„ **New changes pushed to \`develop\`**

          New commits have been merged to the \`develop\` branch.

          **Latest commit:** ${{ github.event.head_commit.message }}
          **Pushed by:** @${{ github.actor }}
          **Commit SHA:** \`${{ github.sha }}\`

          Please review the changes before merging to \`main\`."

          echo "âœ… Updated existing PR #$PR_NUMBER with new changes"

      - name: Create new PR
        if: steps.check-pr.outputs.pr_exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # Get the latest commits from develop (comparing against remote main)
          COMMITS=$(git log --oneline origin/main...HEAD --max-count=10)

          # Get commit message and properly escape it
          COMMIT_MSG=$(cat << 'COMMIT_EOF'
          ${{ github.event.head_commit.message }}
          COMMIT_EOF
          )

          # Create the PR body
          cat > /tmp/pr-body.md << 'EOF'
          ## ðŸš€ Release: Develop to Main

          This PR was automatically created when changes were merged to the `develop` branch.

          ### ðŸ“ Recent Changes

          ```
          EOF

          echo "${COMMITS}" >> /tmp/pr-body.md

          cat >> /tmp/pr-body.md << 'EOF'
          ```

          ### âœ… Pre-merge Checklist

          Before merging this PR to `main`, ensure:

          - [ ] All tests pass (`pnpm test`)
          - [ ] Code has been reviewed
          - [ ] No breaking changes (or properly documented)
          - [ ] Deployment validation passed (`pnpm validate`)
          - [ ] Ready for production deployment

          ### ðŸŒ Deployment Impact

          Merging this PR will trigger:
          - âœ… Cloudflare automatic deployment to production
          - âœ… Updates to all routes:
            - `heri.life` (production)
            - `www.heri.life` (production)
            - `heridotlife.workers.dev` (staging)

          ### ðŸ“Š Review

          EOF

          echo "" >> /tmp/pr-body.md
          echo "**Latest commit:** ${COMMIT_MSG}" >> /tmp/pr-body.md
          echo "**Pushed by:** @${{ github.actor }}" >> /tmp/pr-body.md
          echo "**Commit SHA:** \`${{ github.sha }}\`" >> /tmp/pr-body.md
          echo "" >> /tmp/pr-body.md
          echo "---" >> /tmp/pr-body.md
          echo "" >> /tmp/pr-body.md
          echo "ðŸ¤– This PR was automatically created by GitHub Actions" >> /tmp/pr-body.md

          # Create the PR
          gh pr create \
            --base main \
            --head develop \
            --title "Release: Develop â†’ Main" \
            --body-file /tmp/pr-body.md \
            --draft

          echo "âœ… Created new PR from develop to main"

      - name: Summary
        run: |
          echo "## ðŸ“‹ Auto PR Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check-pr.outputs.pr_exists }}" == "true" ]; then
            echo "âœ… **Updated existing PR #${{ steps.check-pr.outputs.pr_number }}**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Added comment with latest changes from develop branch." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Created new PR from develop to main**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "PR created as **draft** - ready for review and approval." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** Push to develop branch" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Author:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
