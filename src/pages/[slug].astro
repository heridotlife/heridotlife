---
import Layout from '../layouts/Layout.astro';
import { createCachedD1Helper, type ShortUrl } from '../lib/cached-d1';
import { toBool, toDate } from '../lib/d1';
import { siteConfig } from '../consts';

const { slug } = Astro.params;

if (!slug) {
    return Astro.redirect('/404');
}

const reservedPaths = ['admin', 'api', 'category', 'urls', 'c', 'categories'];
if (reservedPaths.includes(slug.toLowerCase())) {
    return Astro.redirect('/404');
}

// Use cached D1 helper for better performance
const db = createCachedD1Helper(
    Astro.locals.runtime.env.D1_db,
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    Astro.locals.runtime.env.heridotlife_kv as any
);

// Initialize variables for category rendering
let shortUrls: ShortUrl[] = [];
let activeUrls: ShortUrl[] = [];
let pageTitle = '';
let pageDescription = '';

// Check if this is a category first (now cached)
const categoryRecord = await db.getCategoryByName(slug);

if (categoryRecord) {
    // This is a category - render the category page (URLs cached)
    shortUrls = await db.getShortUrlsByCategory(categoryRecord.name);
    activeUrls = shortUrls.filter(url => toBool(url.isActive));
    
    pageTitle = `${categoryRecord.name} Links | ${siteConfig.title}`;
    pageDescription = `Browse all links in the ${categoryRecord.name} category`;
    
    // Render category page - no further processing needed
    // The JSX below will handle the category rendering
} else {
    // Not a category, check if it's a short URL (now cached)
    const shortUrlRecord = await db.findShortUrl(slug);

    if (!shortUrlRecord) {
        return Astro.redirect('/categories');
    }

    const isActive = toBool(shortUrlRecord.isActive);
    const expiresAt = shortUrlRecord.expiresAt ? toDate(shortUrlRecord.expiresAt) : null;

    if (!isActive) {
        return new Response('This short URL has been disabled', { status: 410 });
    }

    if (expiresAt && expiresAt < new Date()) {
        return new Response('This short URL has expired', { status: 410 });
    }

    // Update click count (this will invalidate the URL cache)
    await db.incrementClickCount(slug);
    return Astro.redirect(shortUrlRecord.originalUrl, 302);
}

// SVG paths as constants
const linkIcon = "M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1";
const arrowIcon = "M9 5l7 7-7 7";
const backIcon = "M10 19l-7-7m0 0l7-7m-7 7h18";
---

{categoryRecord ? (
    <Layout 
        title={pageTitle} 
        description={pageDescription}
        ogType="category"
        ogCategory={categoryRecord.name}
    >
        <main class="min-h-screen bg-gradient-to-br from-sky-50 via-blue-50 to-cyan-100 dark:from-slate-900 dark:via-sky-950 dark:to-slate-950">
            <button id="theme-toggle" class="fixed top-6 right-6 w-11 h-11 p-2.5 rounded-full bg-white/90 dark:bg-slate-800/90 shadow-lg hover:shadow-xl transition-shadow duration-200 border border-slate-200 dark:border-slate-700 z-50" aria-label="Toggle theme">
                <svg id="sun-icon" style="display: none;" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-amber-500"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2M12 20v2m-8.93-9.07 1.41 1.41m12.02 0 1.41-1.41M2 12h2m16 0h2M4.93 19.07l1.41-1.41m12.02 0l1.41 1.41"></path></svg>
                <svg id="moon-icon" style="display: none;" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6 text-sky-600"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>
            </button>

            <div class="flex flex-col items-center justify-center min-h-screen px-4 py-12">
                <!-- Profile Header Section -->
                <div class="w-full max-w-2xl mx-auto mb-8 text-center">
                    <div class="flex justify-center items-center gap-3 mb-6">
                        <a href="/categories" class="inline-flex items-center text-sky-600 dark:text-sky-400 hover:text-sky-700 dark:hover:text-sky-300 transition-colors text-sm font-medium">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d={backIcon}></path>
                            </svg>
                            Categories
                        </a>
                        <span class="text-slate-400 dark:text-slate-500">|</span>
                        <a href="/" class="inline-flex items-center text-sky-600 dark:text-sky-400 hover:text-sky-700 dark:hover:text-sky-300 transition-colors text-sm font-medium">
                            Home
                        </a>
                    </div>

                    <!-- Profile Avatar - Simplified -->
                    <div class="relative inline-block mb-6">
                        <div class="relative bg-gradient-to-r from-sky-400 via-blue-500 to-cyan-400 p-1 rounded-full">
                            <div class="bg-white dark:bg-slate-900 p-1 rounded-full">
                                <img
                                    class="rounded-full object-cover w-24 h-24 md:w-28 md:h-28"
                                    src="/profile_picture.jpg"
                                    alt="Heri Rusmanto"
                                    width="112"
                                    height="112"
                                    loading="lazy"
                                    decoding="async"
                                />
                            </div>
                        </div>
                    </div>

                    <h1 class="text-3xl md:text-4xl font-bold text-slate-800 dark:text-slate-100 mb-2">
                        {categoryRecord.name}
                    </h1>
                    <p class="text-base text-slate-500 dark:text-slate-400 mb-1">
                        @heridotlife
                    </p>
                    <p class="text-sm text-slate-500 dark:text-slate-400">
                        {activeUrls.length} {activeUrls.length === 1 ? 'link' : 'links'}
                    </p>
                </div>

                <!-- Links List - Optimized -->
                <div class="w-full max-w-2xl mx-auto space-y-4 mb-12">
                    {activeUrls.length === 0 ? (
                        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-lg p-12 text-center border border-slate-200 dark:border-slate-700">
                            <svg class="w-16 h-16 mx-auto mb-4 text-sky-400 dark:text-sky-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d={linkIcon}></path>
                            </svg>
                            <h2 class="text-xl font-semibold text-slate-700 dark:text-slate-300 mb-2">No Links Yet</h2>
                            <p class="text-slate-600 dark:text-slate-400">There are no active links in this category at the moment.</p>
                        </div>
                    ) : (
                        activeUrls.map((url) => (
                            <a 
                                href={`/${url.shortUrl}`}
                                class="group block w-full bg-white dark:bg-slate-800 hover:bg-sky-50 dark:hover:bg-slate-700 rounded-2xl shadow-md hover:shadow-lg transition-shadow duration-200 border border-slate-200 dark:border-slate-700 hover:border-sky-400 dark:hover:border-sky-600 overflow-hidden"
                            >
                                <div class="p-6 flex items-center gap-4 min-h-[100px]">
                                    {/* OG Image or Icon */}
                                    {url.ogImage && url.ogImage.trim() !== '' ? (
                                        <div class="flex-shrink-0">
                                            <img 
                                                src={url.ogImage} 
                                                alt={url.title || 'Link thumbnail'}
                                                class="w-16 h-16 md:w-20 md:h-20 rounded-xl object-cover"
                                                loading="lazy"
                                                decoding="async"
                                                onerror="this.parentElement.innerHTML='<div class=\'flex-shrink-0 w-12 h-12 bg-gradient-to-br from-sky-100 to-cyan-100 dark:from-sky-900 dark:to-cyan-900 rounded-xl flex items-center justify-center\'><svg class=\'w-6 h-6 text-sky-600 dark:text-sky-400\' fill=\'none\' stroke=\'currentColor\' viewBox=\'0 0 24 24\'><path stroke-linecap=\'round\' stroke-linejoin=\'round\' stroke-width=\'2\' d=\'M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1\'></path></svg></div>'"
                                            />
                                        </div>
                                    ) : (
                                        <div class="flex-shrink-0 w-12 h-12 bg-gradient-to-br from-sky-100 to-cyan-100 dark:from-sky-900 dark:to-cyan-900 rounded-xl flex items-center justify-center">
                                            <svg class="w-6 h-6 text-sky-600 dark:text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d={linkIcon}></path>
                                            </svg>
                                        </div>
                                    )}
                                    
                                    {/* Content */}
                                    <div class="flex-1 min-w-0">
                                        <h3 class="text-lg md:text-xl font-bold text-slate-800 dark:text-slate-200 group-hover:text-sky-600 dark:group-hover:text-sky-400 transition-colors mb-1 line-clamp-2">
                                            {url.title || 'Untitled Link'}
                                        </h3>
                                        {url.description && (
                                            <p class="text-sm text-slate-600 dark:text-slate-400 line-clamp-2">
                                                {url.description}
                                            </p>
                                        )}
                                    </div>
                                    
                                    {/* Arrow Icon */}
                                    <svg
                                        class="w-6 h-6 text-slate-400 dark:text-slate-500 group-hover:text-sky-600 dark:group-hover:text-sky-400 transition-colors flex-shrink-0"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d={arrowIcon}
                                        />
                                    </svg>
                                </div>
                            </a>
                        ))
                    )}
                </div>

                <footer class="text-center text-sm text-slate-500 dark:text-slate-400">
                    <p>
                        &copy; {new Date().getFullYear()}
                        <a
                            href="https://heri.life"
                            class="hover:text-sky-600 dark:hover:text-sky-400 transition-colors duration-200 font-medium ml-1"
                        >
                            Heri Rusmanto
                        </a>
                    </p>
                </footer>
            </div>
        </main>
        
        <script is:inline>
            (function() {
                const btn = document.getElementById('theme-toggle');
                const sun = document.getElementById('sun-icon');
                const moon = document.getElementById('moon-icon');
                
                function update() {
                    const isDark = document.documentElement.classList.contains('dark');
                    sun.style.display = isDark ? 'block' : 'none';
                    moon.style.display = isDark ? 'none' : 'block';
                }
                
                update();
                btn.addEventListener('click', () => {
                    document.documentElement.classList.toggle('dark');
                    localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
                    update();
                });
            })();
        </script>
    </Layout>
) : null}
